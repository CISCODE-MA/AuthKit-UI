trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: FE-WEB

steps:
# 1) Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20.x'

# 2) Create project-level .npmrc with all required feeds
- script: |
    cat > .npmrc << 'EOF'
    registry=https://registry.npmjs.org/
    always-auth=true

    @ciscode-template-model:registry=https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/packages-fe/npm/registry/
    @ciscodeapps-template:registry=https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/testfeed/npm/registry/
    @ciscodeapps:registry=https://pkgs.dev.azure.com/CISCODEAPPS/RestoSoft/_packaging/menufeed/npm/registry/
    EOF

    echo "Project .npmrc created:"
    cat .npmrc
  displayName: 'Create .npmrc with Azure Artifacts feeds'

# 3) Authenticate .npmrc against Azure Artifacts (CRITICAL STEP)
- task: npmAuthenticate@0
  displayName: 'Authenticate to Azure Artifacts'
  inputs:
    workingFile: '.npmrc'

# 4) Bump version (build metadata)
- script: |
    VERSION=$(node -p "require('./package.json').version")
    NEW_VERSION="${VERSION}-build.$(Build.BuildId)"
    npm version "$NEW_VERSION" --no-git-tag-version
  displayName: 'Bump package version'

# 5) Install dependencies (NOW AUTH WILL WORK)
- script: npm install
  displayName: 'Install dependencies'

# 6) Build the library
- script: npm run build
  displayName: 'Build Shared Library'

# 7) Publish the package
- script: npm publish --access restricted
  displayName: 'Publish to Private npm Feed'