trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: FE-WEB

steps:
# 1) Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20.x'

# 2) Create .npmrc in the REPO workspace (not ~)
- script: |
    set -euo pipefail

    NPMRC_PATH="$(Build.SourcesDirectory)/.npmrc"

    echo "registry=https://registry.npmjs.org/" > "$NPMRC_PATH"
    echo "always-auth=true" >> "$NPMRC_PATH"

    FEED_REGISTRY="https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/packages-fe/npm/registry/"

    # Scopes that must resolve from Azure Artifacts
    echo "@ciscode-ui:registry=${FEED_REGISTRY}" >> "$NPMRC_PATH"
    echo "@ciscode-template-model:registry=${FEED_REGISTRY}" >> "$NPMRC_PATH"

    echo "Final .npmrc (no secrets):"
    cat "$NPMRC_PATH"
  displayName: 'Configure .npmrc (workspace)'

# 3) Authenticate to Azure Artifacts (injects credentials into that .npmrc)
- task: npmAuthenticate@0
  inputs:
    workingFile: '$(Build.SourcesDirectory)/.npmrc'
  displayName: 'Authenticate to Azure Artifacts'

# 4) Install dependencies using that .npmrc
- script: |
    set -euo pipefail
    npm install --userconfig "$(Build.SourcesDirectory)/.npmrc"
  displayName: 'Install dependencies'

# 5) Build the library
- script: |
    set -euo pipefail
    npm run build --userconfig "$(Build.SourcesDirectory)/.npmrc"
  displayName: 'Build library'

# 6) Bump version (no git tag)
- script: |
    set -euo pipefail
    VERSION=$(node -p "require('./package.json').version")
    NEW_VERSION="${VERSION}-build.$(Build.BuildId)"
    npm version "$NEW_VERSION" --no-git-tag-version
  displayName: 'Bump version'

# 7) Publish to Azure Artifacts (uses same .npmrc)
- script: |
    set -euo pipefail
    npm publish --userconfig "$(Build.SourcesDirectory)/.npmrc"
  displayName: 'Publish to Azure Artifacts feed'