trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: FE-WEB

steps:
# 1) Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20.x'

# 2) Create ~/.npmrc with the correct scope->feed routing (NO token here)
- script: |
    set -euo pipefail

    echo "registry=https://registry.npmjs.org/" > ~/.npmrc
    echo "always-auth=true" >> ~/.npmrc

    FEED_REGISTRY="https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/packages-fe/npm/registry/"

    # Scopes that must resolve from Azure Artifacts
    echo "@ciscode-ui:registry=${FEED_REGISTRY}" >> ~/.npmrc
    echo "@ciscode-template-model:registry=${FEED_REGISTRY}" >> ~/.npmrc

    echo "Final .npmrc (without secrets):"
    cat ~/.npmrc
  displayName: 'Configure npm scopes (no secrets)'

# 3) Authenticate to Azure Artifacts feed (this injects the right secret auth)
- task: npmAuthenticate@0
  inputs:
    workingFile: ~/.npmrc
  displayName: 'Authenticate to Azure Artifacts'

# 4) Install dependencies
- script: npm install
  displayName: 'Install dependencies'

# 5) Build the library
- script: npm run build
  displayName: 'Build library'

# 6) Bump version (kept same behavior as before)
- script: |
    set -euo pipefail
    VERSION=$(node -p "require('./package.json').version")
    NEW_VERSION="${VERSION}-build.$(Build.BuildId)"
    npm version "$NEW_VERSION" --no-git-tag-version
  displayName: 'Bump version'

# 7) Publish to Azure Artifacts (packages-fe)
- script: npm publish
  displayName: 'Publish to Azure Artifacts feed'