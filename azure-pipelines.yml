trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: FE-WEB

steps:
# 1) Install Node.js
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20.x'

# 2) Configure npm to use Azure Artifacts for @ciscode-ui
- script: |
    echo "registry=https://registry.npmjs.org/" > ~/.npmrc
    echo "always-auth=true" >> ~/.npmrc

    # Azure Artifacts feed for @ciscode-ui
    echo "@ciscode-ui:registry=https://pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/packages-fe/npm/registry/" >> ~/.npmrc
    echo "//pkgs.dev.azure.com/CISCODEAPPS/Templates/_packaging/packages-fe/npm/registry/:_authToken=$(TOKEN_ACCESS_AZURE_ARTIFACT)" >> ~/.npmrc

    # Optional version bump
    VERSION=$(node -p "require('./package.json').version")
    NEW_VERSION="${VERSION}-build.$(Build.BuildId)"
    npm version "$NEW_VERSION" --no-git-tag-version

    echo "Final .npmrc:"
    cat ~/.npmrc
  displayName: 'Configure npmrc for Azure Artifacts'

# 3) Install dependencies
- script: npm install
  displayName: 'Install dependencies'

# 4) Build the library
- script: npm run build
  displayName: 'Build library'

# 5) Publish to Azure Artifacts (packages-fe)
- script: npm publish
  displayName: 'Publish to Azure Artifacts feed'